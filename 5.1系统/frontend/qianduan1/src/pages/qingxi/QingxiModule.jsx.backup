/**
 * æ¸…æ´—æ¨¡å—é¡µé¢ - æ•°æ®æ”¶é›†å™¨ç®¡ç†å’Œæ•°æ®è´¨é‡ç›‘æ§
 */

import { useState, useEffect, useCallback } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import Navigation from '../../components/Navigation.jsx';
import apiService from '../../services/api.js';
import { 
  COLLECTOR_STATUS, 
  REFRESH_INTERVALS, 
  SUCCESS_MESSAGES, 
  ERROR_MESSAGES 
} from '../../utils/constants.js';
import { 
  formatTime, 
  getStatusColor,
  cn
} from '../../utils/helpers.js';

// æ•°æ®æ”¶é›†å™¨å¡ç‰‡ç»„ä»¶
const CollectorCard = ({ collector, onStart, onStop, loading }) => {
  const { id, name, status } = collector;
  const statusColor = getStatusColor(status === 'running' ? 'running' : 'stopped');
  const isRunning = status === 'running';
  
  return (
    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <div 
            className="w-4 h-4 rounded-full"
            style={{ backgroundColor: statusColor }}
          />
          <h3 className="text-lg font-semibold text-gray-900">{name}</h3>
        </div>
        <span 
          className="px-3 py-1 rounded-full text-sm font-medium"
          style={{ 
            color: statusColor,
            backgroundColor: `${statusColor}20`
          }}
        >
          {isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}
        </span>
      </div>
      
      <div className="mb-4">
        <p className="text-sm text-gray-500 mb-1">æ”¶é›†å™¨ID</p>
        <p className="text-gray-900 font-mono text-sm">{id}</p>
      </div>
      
      <div className="flex gap-3">
        <button
          onClick={() => onStart(id)}
          disabled={loading || isRunning}
          className={cn(
            'flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200',
            'disabled:opacity-50 disabled:cursor-not-allowed',
            !isRunning && !loading
              ? 'bg-green-600 hover:bg-green-700 text-white shadow-sm'
              : 'bg-gray-100 text-gray-400'
          )}
        >
          {loading ? 'å¯åŠ¨ä¸­...' : 'å¯åŠ¨æ”¶é›†å™¨'}
        </button>
        <button
          onClick={() => onStop(id)}
          disabled={loading || !isRunning}
          className={cn(
            'flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200',
            'disabled:opacity-50 disabled:cursor-not-allowed',
            isRunning && !loading
              ? 'bg-red-600 hover:bg-red-700 text-white shadow-sm'
              : 'bg-gray-100 text-gray-400'
          )}
        >
          {loading ? 'åœæ­¢ä¸­...' : 'åœæ­¢æ”¶é›†å™¨'}
        </button>
      </div>
    </div>
  );
};

// æ•°æ®è´¨é‡ç›‘æ§å¡ç‰‡
const DataQualityCard = () => {
  // ä½¿ç”¨çœŸå®APIè·å–æ•°æ®è´¨é‡æŒ‡æ ‡
  const { data: qualityData, isLoading: qualityLoading, error: qualityError } = useQuery({
    queryKey: ['dataQuality'],
    queryFn: async () => {
      try {
        console.log('å¼€å§‹è·å–æ•°æ®è´¨é‡...');
        const result = await apiService.qingxi.getDataQuality();
        console.log('æ•°æ®è´¨é‡è·å–ç»“æœ:', result);
        return result;
      } catch (error) {
        console.error('è·å–æ•°æ®è´¨é‡å¤±è´¥:', error);
        // ä¸æŠ›å‡ºé”™è¯¯ï¼Œè¿”å›é»˜è®¤å€¼
        return { data: { totalRecords: 0, validRecords: 0, dataQualityScore: 0, exchangeData: {} } };
      }
    },
    refetchInterval: 4000, // 4ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œå®ç°3-5ç§’è‡ªåŠ¨åˆ·æ–°
    select: (response) => response.data?.data || response.data,
  });

  if (qualityLoading || !qualityData) {
    return (
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div className="animate-pulse">
          <div className="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
          <div className="space-y-3">
            <div className="h-16 bg-gray-200 rounded"></div>
            <div className="h-3 bg-gray-200 rounded w-3/4"></div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 className="text-lg font-semibold text-gray-900 mb-4">æ•°æ®è´¨é‡ç›‘æ§</h3>
      
      {/* æ€»ä½“æ•°æ®è´¨é‡è¯„åˆ† */}
      <div className="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm text-gray-600">æ•°æ®è´¨é‡è¯„åˆ†</p>
            <p className="text-3xl font-bold text-blue-600">
              {qualityData.dataQualityScore.toFixed(2)}%
            </p>
          </div>
          <div className="w-16 h-16 relative">
            <svg className="w-16 h-16 transform -rotate-90" viewBox="0 0 36 36">
              <path
                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke="#e5e7eb"
                strokeWidth="3"
              />
              <path
                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke="#3b82f6"
                strokeWidth="3"
                strokeDasharray={`${qualityData.dataQualityScore.toFixed(2)}, 100`}
              />
            </svg>
          </div>
        </div>
      </div>

      {/* æ•°æ®ç»Ÿè®¡ */}
      <div className="grid grid-cols-3 gap-4 mb-4">
        <div className="text-center">
          <p className="text-2xl font-semibold text-gray-900">
            {qualityData.totalRecords.toLocaleString()}
          </p>
          <p className="text-sm text-gray-500">æ€»è®°å½•æ•°</p>
        </div>
        <div className="text-center">
          <p className="text-2xl font-semibold text-green-600">
            {qualityData.validRecords.toLocaleString()}
          </p>
          <p className="text-sm text-gray-500">æœ‰æ•ˆè®°å½•</p>
        </div>
        <div className="text-center">
          <p className="text-2xl font-semibold text-red-600">
            {qualityData.invalidRecords.toLocaleString()}
          </p>
          <p className="text-sm text-gray-500">æ— æ•ˆè®°å½•</p>
        </div>
      </div>

      {/* äº¤æ˜“æ‰€æ•°æ®è´¨é‡ */}
      <div className="space-y-3">
        <h4 className="text-md font-medium text-gray-900">å„äº¤æ˜“æ‰€æ•°æ®è´¨é‡</h4>
        {Object.entries(qualityData.exchangeData).map(([exchange, data]) => (
          <div key={exchange} className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="capitalize font-medium text-gray-700">
                {exchange}
              </span>
              <span className="text-sm text-gray-500">
                {data.records.toLocaleString()} è®°å½•
              </span>
            </div>
            <div className="flex items-center gap-2">
              <span className="text-sm font-medium text-gray-900">
                {data.quality.toFixed(2)}%
              </span>
              <div className="w-20 bg-gray-200 rounded-full h-2">
                <div
                  className="bg-green-500 h-2 rounded-full transition-all duration-300"
                  style={{ width: `${data.quality}%` }}
                />
              </div>
            </div>
          </div>
        ))}
      </div>
      
      <div className="mt-4 pt-4 border-t border-gray-200">
        <p className="text-xs text-gray-500">
          æœ€åæ›´æ–°: {formatTime(new Date(qualityData.lastUpdated))}
        </p>
      </div>
    </div>
  );
};

// æ•°æ®æµç›‘æ§å¡ç‰‡
const DataFlowCard = () => {
  // ä½¿ç”¨çœŸå®APIè·å–æ•°æ®æµé‡ç»Ÿè®¡ï¼Œæ¯3-5ç§’åˆ·æ–°
  const { data: flowData, isLoading: flowLoading, error: flowError } = useQuery({
    queryKey: ['dataFlow'],
    queryFn: async () => {
      try {
        console.log('å¼€å§‹è·å–æ•°æ®æµé‡...');
        const result = await apiService.qingxi.getDataFlow();
        console.log('æ•°æ®æµé‡è·å–ç»“æœ:', result);
        return result;
      } catch (error) {
        console.error('è·å–æ•°æ®æµé‡å¤±è´¥:', error);
        // ä¸æŠ›å‡ºé”™è¯¯ï¼Œè¿”å›é»˜è®¤å€¼
        return { data: { realTimeFlow: 0, avgFlowPerMin: 0, peakFlow: 0, flowTrend: 'stable', v3Plus01Status: 'inactive', zeroAllocationStatus: 'disabled' } };
      }
    },
    refetchInterval: 3000, // 3ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œå®ç°3-5ç§’è‡ªåŠ¨åˆ·æ–°
    select: (response) => response.data?.data || response.data,
  });

  if (flowLoading || !flowData) {
    return (
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div className="animate-pulse">
          <div className="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
          <div className="grid grid-cols-2 gap-4">
            {[1, 2, 3, 4].map((i) => (
              <div key={i} className="space-y-2">
                <div className="h-3 bg-gray-200 rounded w-3/4"></div>
                <div className="h-6 bg-gray-200 rounded w-full"></div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 className="text-lg font-semibold text-gray-900 mb-4">å®æ—¶æ•°æ®æµç›‘æ§</h3>
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <p className="text-sm text-gray-500">å®æ—¶æµé‡</p>
          <p className="text-2xl font-bold text-blue-600">
            {flowData.realTimeFlow} <span className="text-sm font-normal">æ¡/ç§’</span>
          </p>
        </div>
        <div>
          <p className="text-sm text-gray-500">å¹³å‡æµé‡</p>
          <p className="text-2xl font-bold text-green-600">
            {flowData.avgFlowPerMin} <span className="text-sm font-normal">æ¡/åˆ†é’Ÿ</span>
          </p>
        </div>
        <div>
          <p className="text-sm text-gray-500">å³°å€¼æµé‡</p>
          <p className="text-2xl font-bold text-orange-600">
            {flowData.peakFlow} <span className="text-sm font-normal">æ¡/ç§’</span>
          </p>
        </div>
        <div>
          <p className="text-sm text-gray-500">æµé‡è¶‹åŠ¿</p>
          <p className={cn(
            "text-lg font-semibold",
            flowData.flowTrend === 'increasing' ? 'text-green-600' : 
            flowData.flowTrend === 'stable' ? 'text-blue-600' :
            flowData.flowTrend === 'stopped' ? 'text-gray-600' : 'text-red-600'
          )}>
            {flowData.flowTrend === 'increasing' ? 'â†—ï¸ ä¸Šå‡ä¸­' : 
             flowData.flowTrend === 'stable' ? 'âš¡ ç¨³å®šä¸­' :
             flowData.flowTrend === 'stopped' ? 'â¹ï¸ å·²åœæ­¢' : 'â†˜ï¸ ä¸‹é™ä¸­'}
          </p>
        </div>
      </div>

      {/* v3+o1 å’Œé›¶åˆ†é…çŠ¶æ€æ˜¾ç¤º */}
      <div className="mt-4 pt-4 border-t border-gray-200">
        <h4 className="text-sm font-medium text-gray-900 mb-2">ç³»ç»Ÿå¯åŠ¨çŠ¶æ€æ£€æŸ¥</h4>
        <div className="grid grid-cols-2 gap-3">
          <div className="flex items-center gap-2">
            <div 
              className={cn(
                "w-3 h-3 rounded-full",
                flowData.v3Plus01Status === 'active' ? 'bg-green-500' : 'bg-gray-400'
              )}
            />
            <span className="text-sm text-gray-600">v3+o1</span>
            <span className={cn(
              "text-xs px-2 py-1 rounded-full font-medium",
              flowData.v3Plus01Status === 'active' 
                ? 'bg-green-100 text-green-800' 
                : 'bg-gray-100 text-gray-600'
            )}>
              {flowData.v3Plus01Status === 'active' ? 'å·²å¯åŠ¨' : 'æœªå¯åŠ¨'}
            </span>
          </div>
          <div className="flex items-center gap-2">
            <div 
              className={cn(
                "w-3 h-3 rounded-full",
                flowData.zeroAllocationStatus === 'enabled' ? 'bg-green-500' : 'bg-gray-400'
              )}
            />
            <span className="text-sm text-gray-600">é›¶åˆ†é…</span>
            <span className={cn(
              "text-xs px-2 py-1 rounded-full font-medium",
              flowData.zeroAllocationStatus === 'enabled' 
                ? 'bg-green-100 text-green-800' 
                : 'bg-gray-100 text-gray-600'
            )}>
              {flowData.zeroAllocationStatus === 'enabled' ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}
            </span>
          </div>
        </div>
      </div>
    </div>
  );
};

// æ¸…æ´—é€Ÿåº¦ç»Ÿè®¡å¡ç‰‡
const CleanStatsCard = () => {
  const [expandedExchange, setExpandedExchange] = useState(null);
  
  // è·å–æ¸…æ´—é€Ÿåº¦ç»Ÿè®¡ï¼Œæ¯3ç§’åˆ·æ–°
  const { data: cleanStats, isLoading: statsLoading, error: statsError } = useQuery({
    queryKey: ['cleanStats'],
    queryFn: async () => {
      try {
        console.log('å¼€å§‹è·å–æ¸…æ´—é€Ÿåº¦ç»Ÿè®¡...');
        const result = await apiService.qingxi.getCleanStats();
        console.log('æ¸…æ´—é€Ÿåº¦ç»Ÿè®¡è·å–ç»“æœ:', result);
        return result;
      } catch (error) {
        console.error('è·å–æ¸…æ´—é€Ÿåº¦ç»Ÿè®¡å¤±è´¥:', error);
        return { data: { totalPairs: 0, avgCleanTime: 0, fastestPair: null, slowestPair: null, allPairs: [] } };
      }
    },
    refetchInterval: 3000, // 3ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œç¡®ä¿çœŸæ­£å®æ—¶æ›´æ–°
    select: (response) => response.data?.data || response.data,
  });

  // è·å–æ”¶é›†å™¨è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…å«æ¯ä¸ªäº¤æ˜“å¯¹çš„æ¸…æ´—æ—¶é—´
  const { data: collectorsData } = useQuery({
    queryKey: ['collectors'],
    queryFn: async () => {
      try {
        const result = await apiService.qingxi.getCollectors();
        return result;
      } catch (error) {
        console.error('è·å–æ”¶é›†å™¨å¤±è´¥:', error);
        return { data: [] };
      }
    },
    refetchInterval: 3000, // 3ç§’åˆ·æ–°ä¸€æ¬¡
    select: (response) => response.data?.data || response.data,
  });

  if (statsLoading || !cleanStats) {
    return (
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div className="animate-pulse">
          <div className="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
          <div className="space-y-3">
            <div className="h-12 bg-gray-200 rounded"></div>
            <div className="h-3 bg-gray-200 rounded w-3/4"></div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 className="text-lg font-semibold text-gray-900 mb-4">æ¸…æ´—é€Ÿåº¦ç»Ÿè®¡</h3>
      
      {/* æ€»ä½“ç»Ÿè®¡ */}
      <div className="grid grid-cols-2 gap-4 mb-4">
        <div className="text-center p-3 bg-blue-50 rounded-lg">
          <p className="text-2xl font-bold text-blue-600">{cleanStats.totalPairs}</p>
          <p className="text-sm text-gray-600">äº¤æ˜“å¯¹æ€»æ•°</p>
        </div>
        <div className="text-center p-3 bg-green-50 rounded-lg">
          <p className="text-2xl font-bold text-green-600">{cleanStats.avgCleanTime}ms</p>
          <p className="text-sm text-gray-600">å¹³å‡æ¸…æ´—æ—¶é—´</p>
        </div>
      </div>

      {/* æœ€å¿«å’Œæœ€æ…¢äº¤æ˜“å¯¹ */}
      <div className="space-y-3">
        {cleanStats.fastestPair && (
          <div className="flex items-center justify-between p-3 bg-green-50 rounded-lg">
            <div className="flex items-center gap-3">
              <div className="w-3 h-3 bg-green-500 rounded-full"></div>
              <div>
                <p className="font-medium text-green-800">ğŸš€ æœ€å¿«æ¸…æ´—</p>
                <p className="text-sm text-green-600">
                  {cleanStats.fastestPair.pair} ({cleanStats.fastestPair.exchange})
                </p>
              </div>
            </div>
            <div className="text-right">
              <p className="font-bold text-green-800">{cleanStats.fastestPair.cleanTime}ms</p>
              <p className="text-xs text-green-600">{cleanStats.fastestPair.efficiency}% æ•ˆç‡</p>
            </div>
          </div>
        )}

        {cleanStats.slowestPair && (
          <div className="flex items-center justify-between p-3 bg-orange-50 rounded-lg">
            <div className="flex items-center gap-3">
              <div className="w-3 h-3 bg-orange-500 rounded-full"></div>
              <div>
                <p className="font-medium text-orange-800">ğŸŒ æœ€æ…¢æ¸…æ´—</p>
                <p className="text-sm text-orange-600">
                  {cleanStats.slowestPair.pair} ({cleanStats.slowestPair.exchange})
                </p>
              </div>
            </div>
            <div className="text-right">
              <p className="font-bold text-orange-800">{cleanStats.slowestPair.cleanTime}ms</p>
              <p className="text-xs text-orange-600">{cleanStats.slowestPair.efficiency}% æ•ˆç‡</p>
            </div>
          </div>
        )}
      </div>

      {/* äº¤æ˜“æ‰€è¯¦ç»†ä¿¡æ¯æŠ˜å åŒºåŸŸ */}
      <div className="mt-4 pt-4 border-t border-gray-200">
        <h4 className="text-sm font-medium text-gray-900 mb-3">å„äº¤æ˜“æ‰€æ¸…æ´—è¯¦æƒ…</h4>
        <div className="space-y-2">
          {collectorsData && collectorsData.map(collector => (
            <div key={collector.id} className="border border-gray-200 rounded-lg">
              <button
                className="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 transition-colors"
                onClick={() => setExpandedExchange(expandedExchange === collector.id ? null : collector.id)}
              >
                <div className="flex items-center gap-3">
                  <div 
                    className={cn(
                      "w-3 h-3 rounded-full",
                      collector.status === 'running' ? 'bg-green-500' : 'bg-gray-400'
                    )}
                  />
                  <span className="font-medium text-gray-900 capitalize">
                    {collector.exchange}
                  </span>
                  <span className="text-sm text-gray-500">
                    ({collector.pairs ? collector.pairs.length : 0} äº¤æ˜“å¯¹)
                  </span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-600">
                    {collector.status === 'running' ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}
                  </span>
                  <svg
                    className={cn(
                      "w-4 h-4 text-gray-400 transition-transform",
                      expandedExchange === collector.id ? "rotate-180" : ""
                    )}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </button>
              
              {expandedExchange === collector.id && collector.pairDetails && (
                <div className="px-4 pb-4 border-t border-gray-100">
                  <div className="mt-3 space-y-2">
                    {Object.entries(collector.pairDetails).map(([pair, details]) => (
                      <div key={pair} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <div className="flex items-center gap-2">
                          <div 
                            className={cn(
                              "w-2 h-2 rounded-full",
                              details.status === 'running' ? 'bg-green-500' : 'bg-gray-400'
                            )}
                          />
                          <span className="font-mono text-sm text-gray-700">{pair}</span>
                        </div>
                        <div className="flex items-center gap-4">
                          <div className="text-right">
                            <p className="text-sm font-medium text-gray-900">
                              {details.cleanTime || 0}ms
                            </p>
                            <p className="text-xs text-gray-500">
                              {details.efficiency || 0}% æ•ˆç‡
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="text-sm text-gray-600">
                              {(details.dataCount || 0).toLocaleString()} æ¡
                            </p>
                            <p className="text-xs text-gray-500">
                              æ•°æ®é‡
                            </p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  {collector.status === 'running' && (
                    <div className="mt-2 text-xs text-green-600">
                      âš¡ å®æ—¶æ›´æ–°ä¸­ï¼Œæ¯3ç§’åˆ·æ–°æ¸…æ´—æ—¶é—´
                    </div>
                  )}
                </div>
              )}
            </div>
          ))}
        </div>
        
        <div className="mt-3 text-xs text-gray-500">
          ğŸ“Š å®æ—¶ç›‘æ§æ‰€æœ‰äº¤æ˜“å¯¹æ¸…æ´—æ€§èƒ½ï¼Œæ¯3ç§’æ›´æ–°ä¸€æ¬¡
        </div>
      </div>
    </div>
  );
};

// ä¸»æ¸…æ´—æ¨¡å—é¡µé¢ç»„ä»¶
const QingxiModule = () => {
  const queryClient = useQueryClient();
  const [notification, setNotification] = useState(null);
  const [operatingCollector, setOperatingCollector] = useState(null);
  const [hasError, setHasError] = useState(false);
  
  // é”™è¯¯è¾¹ç•Œ
  useEffect(() => {
    const handleError = (error) => {
      console.error('æ¸…æ´—æ¨¡å—é¡µé¢é”™è¯¯:', error);
      setHasError(true);
    };
    
    window.addEventListener('error', handleError);
    return () => window.removeEventListener('error', handleError);
  }, []);
  
  // å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯é¡µé¢
  if (hasError) {
    return (
      <div className="min-h-screen bg-gray-50 p-6">
        <div className="max-w-4xl mx-auto">
          <Navigation />
          <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center mt-8">
            <p className="text-red-600 text-lg font-medium mb-2">
              é¡µé¢åŠ è½½å‡ºç°é”™è¯¯
            </p>
            <p className="text-red-500 text-sm mb-4">
              è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
            </p>
            <button
              onClick={() => {
                setHasError(false);
                window.location.reload();
              }}
              className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
            >
              é‡æ–°åŠ è½½é¡µé¢
            </button>
          </div>
        </div>
      </div>
    );
  }
  
  // è·å–æ•°æ®æ”¶é›†å™¨åˆ—è¡¨
  const { data: collectors = [], isLoading, error } = useQuery({
    queryKey: ['collectors'],
    queryFn: async () => {
      try {
        console.log('å¼€å§‹è·å–æ”¶é›†å™¨åˆ—è¡¨...');
        const result = await apiService.qingxi.getCollectors();
        console.log('æ”¶é›†å™¨åˆ—è¡¨è·å–ç»“æœ:', result);
        return result;
      } catch (error) {
        console.error('è·å–æ”¶é›†å™¨åˆ—è¡¨å¤±è´¥:', error);
        throw error;
      }
    },
    refetchInterval: REFRESH_INTERVALS.NORMAL,
    select: (response) => {
      console.log('å¤„ç†æ”¶é›†å™¨åˆ—è¡¨æ•°æ®:', response);
      const data = response.data || response || [];
      console.log('æœ€ç»ˆæ”¶é›†å™¨æ•°æ®:', data);
      return data;
    },
    retry: 3,
    retryDelay: 1000,
  });
  
  // æ˜¾ç¤ºé€šçŸ¥
  const showNotification = useCallback((message, type = 'info') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 4000);
  }, []);
  
  // å¯åŠ¨æ”¶é›†å™¨
  const startCollectorMutation = useMutation({
    mutationFn: (collectorId) => apiService.qingxi.startCollector(collectorId),
    onMutate: (collectorId) => {
      setOperatingCollector(collectorId);
    },
    onSuccess: (response, collectorId) => {
      queryClient.invalidateQueries(['collectors']);
      showNotification(`æ”¶é›†å™¨ ${collectorId} å¯åŠ¨æˆåŠŸ`, 'success');
    },
    onError: (error, collectorId) => {
      showNotification(`æ”¶é›†å™¨ ${collectorId} å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
    },
    onSettled: () => {
      setOperatingCollector(null);
    },
  });
  
  // åœæ­¢æ”¶é›†å™¨
  const stopCollectorMutation = useMutation({
    mutationFn: (collectorId) => apiService.qingxi.stopCollector(collectorId),
    onMutate: (collectorId) => {
      setOperatingCollector(collectorId);
    },
    onSuccess: (response, collectorId) => {
      queryClient.invalidateQueries(['collectors']);
      showNotification(`æ”¶é›†å™¨ ${collectorId} å·²åœæ­¢`, 'success');
    },
    onError: (error, collectorId) => {
      showNotification(`æ”¶é›†å™¨ ${collectorId} åœæ­¢å¤±è´¥: ${error.message}`, 'error');
    },
    onSettled: () => {
      setOperatingCollector(null);
    },
  });
  
  if (error) {
    return (
      <div className="min-h-screen bg-gray-50 p-6">
        <div className="max-w-4xl mx-auto">
          <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
            <p className="text-red-600 text-lg font-medium mb-2">
              æ¸…æ´—æ¨¡å—æ•°æ®åŠ è½½å¤±è´¥
            </p>
            <p className="text-red-500 text-sm">
              {error.message}
            </p>
            <button
              onClick={() => queryClient.invalidateQueries(['collectors'])}
              className="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
            >
              é‡è¯•
            </button>
          </div>
        </div>
      </div>
    );
  }
  
  return (
    <div className="min-h-screen bg-gray-50 p-6">
      {/* é€šçŸ¥ç»„ä»¶ */}
      {notification && (
        <div className={cn(
          'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm',
          notification.type === 'success' && 'bg-green-50 border border-green-200 text-green-800',
          notification.type === 'error' && 'bg-red-50 border border-red-200 text-red-800',
          notification.type === 'info' && 'bg-blue-50 border border-blue-200 text-blue-800'
        )}>
          {notification.message}
        </div>
      )}

      {/* å¯¼èˆªæ  */}
      <Navigation />
      
      <div className="max-w-7xl mx-auto">
        {/* é¡µé¢æ ‡é¢˜ */}
        <div className="mb-6">
          <h1 className="text-3xl font-bold text-gray-900">æ¸…æ´—æ¨¡å—</h1>
          <p className="text-gray-600 mt-1">
            æ•°æ®æ”¶é›†å™¨ç®¡ç†ã€æ•°æ®è´¨é‡ç›‘æ§å’Œå®æ—¶æ•°æ®æµåˆ†æ
          </p>
        </div>
        
        {isLoading ? (
          <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            {/* åŠ è½½å ä½ç¬¦ */}
            {[1, 2, 3, 4, 5, 6].map((i) => (
              <div key={i} className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div className="animate-pulse">
                  <div className="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                  <div className="space-y-3">
                    <div className="h-3 bg-gray-200 rounded"></div>
                    <div className="h-3 bg-gray-200 rounded w-5/6"></div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div className="space-y-6">
            {/* æ•°æ®æ”¶é›†å™¨ç®¡ç†åŒºåŸŸ */}
            <div>
              <h2 className="text-xl font-semibold text-gray-900 mb-4">æ•°æ®æ”¶é›†å™¨ç®¡ç†</h2>
              <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                {collectors.map((collector) => (
                  <CollectorCard
                    key={collector.id}
                    collector={collector}
                    onStart={() => startCollectorMutation.mutate(collector.id)}
                    onStop={() => stopCollectorMutation.mutate(collector.id)}
                    loading={operatingCollector === collector.id}
                  />
                ))}
              </div>
            </div>
            
            {/* æ•°æ®è´¨é‡å’Œæµç›‘æ§åŒºåŸŸ */}
            <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
              <DataQualityCard />
              <DataFlowCard />
              <CleanStatsCard />
            </div>
          </div>
        )}
        
        {/* é¡µé¢åº•éƒ¨ä¿¡æ¯ */}
        <div className="mt-8 text-center text-sm text-gray-500">
          æœ€åæ›´æ–°: {formatTime(new Date())} | 
          åˆ·æ–°é—´éš”: {REFRESH_INTERVALS.NORMAL / 1000}ç§’ | 
          æ•°æ®æ”¶é›†å™¨æ•°é‡: {collectors.length}
        </div>
      </div>
    </div>
  );
};

export default QingxiModule;