# 5.1å¥—åˆ©ç³»ç»Ÿåç«¯æ¶æ„å®Œæ•´å¼€å‘æ€»ç»“æ–‡æ¡£

## ğŸ“‘ æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **ç³»ç»Ÿç‰ˆæœ¬**: 5.1.0
- **æ›´æ–°æ—¥æœŸ**: 2025-09-06
- **ä½œè€…**: 5.1ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ

---

## ğŸ¯ ç›®å½•
1. [åç«¯æ¶æ„è®¾è®¡](#åç«¯æ¶æ„è®¾è®¡)
2. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
3. [ä»£ç å®ç°ä¸è¿è¡Œé€»è¾‘](#ä»£ç å®ç°ä¸è¿è¡Œé€»è¾‘)
4. [åŠŸèƒ½é…ç½®è¯¦è§£](#åŠŸèƒ½é…ç½®è¯¦è§£)
5. [æ¨¡å—å‚æ•°è®¾ç½®](#æ¨¡å—å‚æ•°è®¾ç½®)
6. [æ•°æ®æµè½¬é€»è¾‘](#æ•°æ®æµè½¬é€»è¾‘)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
8. [éƒ¨ç½²ä¸è¿ç»´](#éƒ¨ç½²ä¸è¿ç»´)
9. [æ•…éšœå¤„ç†æ–¹æ¡ˆ](#æ•…éšœå¤„ç†æ–¹æ¡ˆ)
10. [å¼€å‘æœ€ä½³å®è·µ](#å¼€å‘æœ€ä½³å®è·µ)

---

## ğŸ—ï¸ åç«¯æ¶æ„è®¾è®¡

### 1. æ•´ä½“æ¶æ„æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    5.1å¥—åˆ©ç³»ç»Ÿåç«¯æ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    API Gateway Layer                      â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Express HTTP Server (Port 8080)                     â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ CORS Middleware                                     â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Request Validation                                  â”‚ â”‚
â”‚  â”‚  â””â”€â”€ Response Formatting                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  Business Logic Layer                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚   System    â”‚  â”‚   QingXi    â”‚  â”‚    CeLue    â”‚      â”‚ â”‚
â”‚  â”‚  â”‚   Control   â”‚  â”‚   Module    â”‚  â”‚   Module    â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚    Risk     â”‚  â”‚Architecture â”‚  â”‚ Observabilityâ”‚      â”‚ â”‚
â”‚  â”‚  â”‚ Management  â”‚  â”‚  Monitor    â”‚  â”‚   Module    â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     Data Layer                            â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ System State Management                              â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Performance Metrics                                  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Configuration Storage                                â”‚ â”‚
â”‚  â”‚  â””â”€â”€ Log Aggregation                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 External Services                         â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Exchange APIs (Binance, OKX, Huobi)                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Market Data Feeds                                   â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Notification Services                               â”‚ â”‚
â”‚  â”‚  â””â”€â”€ Monitoring Systems                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æŠ€æœ¯æ ˆé€‰æ‹©ç†ç”±

| æŠ€æœ¯ç»„ä»¶ | é€‰æ‹© | ç†ç”± |
|---------|------|------|
| **è¿è¡Œç¯å¢ƒ** | Node.js | å¼‚æ­¥I/Oã€äº‹ä»¶é©±åŠ¨ã€é«˜å¹¶å‘å¤„ç†èƒ½åŠ› |
| **Webæ¡†æ¶** | Express.js | è½»é‡çº§ã€ä¸­é—´ä»¶æœºåˆ¶æˆç†Ÿã€ç”Ÿæ€ä¸°å¯Œ |
| **è·¨åŸŸå¤„ç†** | CORS | æ”¯æŒå‰åç«¯åˆ†ç¦»æ¶æ„ã€çµæ´»é…ç½® |
| **è¿›ç¨‹ç®¡ç†** | Systemd | ç³»ç»Ÿçº§ç®¡ç†ã€è‡ªåŠ¨é‡å¯ã€æ—¥å¿—ç®¡ç† |
| **ç›‘æ§å·¥å…·** | Shell Script | è½»é‡çº§ã€å®æ—¶ç›‘æ§ã€æ˜“äºå®šåˆ¶ |

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. ç³»ç»Ÿæ§åˆ¶æ¨¡å— (System Control Module)

#### æ¨¡å—èŒè´£
- ç³»ç»Ÿç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆå¯åŠ¨/åœæ­¢/é‡å¯ï¼‰
- ç³»ç»ŸçŠ¶æ€ç›‘æ§ä¸æŠ¥å‘Š
- æ€§èƒ½æŒ‡æ ‡æ”¶é›†ä¸åˆ†æ
- æ¨¡å—å¥åº·æ£€æŸ¥

#### æ ¸å¿ƒä»£ç å®ç°
```javascript
// ç³»ç»ŸçŠ¶æ€æ•°æ®ç»“æ„
let systemStatus = {
  isRunning: false,               // ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
  lastStarted: null,              // æœ€åå¯åŠ¨æ—¶é—´
  cpu_usage: 0,                   // CPUä½¿ç”¨ç‡
  memory_usage: 0,                // å†…å­˜ä½¿ç”¨ç‡
  network_latency: 0,             // ç½‘ç»œå»¶è¿Ÿ
  version: "5.1.0",               // ç³»ç»Ÿç‰ˆæœ¬
  uptime: 0,                      // è¿è¡Œæ—¶é•¿ï¼ˆå°æ—¶ï¼‰
  modules: {                      // æ¨¡å—çŠ¶æ€
    system: { status: 'stopped', health: 'unknown' },
    qingxi: { status: 'stopped', health: 'unknown' },
    celue: { status: 'stopped', health: 'unknown' },
    risk: { status: 'stopped', health: 'unknown' }
  }
};

// ç³»ç»Ÿå¯åŠ¨é€»è¾‘
app.post('/api/system/start', (req, res) => {
  console.log('ğŸš€ å¯åŠ¨ç³»ç»Ÿè¯·æ±‚');
  
  // çŠ¶æ€æ£€æŸ¥
  if (systemStatus.isRunning) {
    return res.json({
      success: true,
      message: 'ç³»ç»Ÿå·²åœ¨è¿è¡Œä¸­',
      data: { status: 'already_running' }
    });
  }

  // å¯åŠ¨ç³»ç»Ÿ
  systemStatus.isRunning = true;
  systemStatus.lastStarted = new Date().toISOString();
  
  // å¯åŠ¨æ‰€æœ‰æ¨¡å—
  Object.keys(systemStatus.modules).forEach(module => {
    systemStatus.modules[module] = { 
      status: 'running', 
      health: 'healthy'
    };
  });
  
  // å¯åŠ¨æ•°æ®æ”¶é›†å™¨
  dataCollectors.forEach(collector => {
    collector.status = 'running';
  });
  
  // è®°å½•å¯åŠ¨æ—¥å¿—
  const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
  systemLogs.push(`${timestamp} [INFO] âœ… ç³»ç»Ÿå¯åŠ¨æˆåŠŸ`);
  
  res.json({
    success: true,
    message: 'ç³»ç»Ÿå¯åŠ¨æˆåŠŸï¼',
    data: {
      status: 'started',
      message: '5.1å¥—åˆ©ç³»ç»Ÿå·²æˆåŠŸå¯åŠ¨'
    }
  });
});
```

### 2. æ¸…æ´—æ¨¡å— (QingXi - Data Processing Module)

#### æ¨¡å—èŒè´£
- æ•°æ®æ”¶é›†å™¨ç®¡ç†
- å®æ—¶æ•°æ®æ¸…æ´—
- æ•°æ®è´¨é‡ç›‘æ§
- æ•°æ®å½’ä¸€åŒ–å¤„ç†

#### æ•°æ®æ”¶é›†å™¨é…ç½®
```javascript
// æ•°æ®æ”¶é›†å™¨é…ç½®
let dataCollectors = [
  { 
    id: 'collector_001', 
    name: 'Binanceæ•°æ®æ”¶é›†å™¨', 
    status: 'stopped',
    config: {
      exchange: 'binance',
      symbols: ['BTC/USDT', 'ETH/USDT'],
      interval: 1000,        // é‡‡é›†é—´éš”(ms)
      batchSize: 100,        // æ‰¹å¤„ç†å¤§å°
      timeout: 5000,         // è¶…æ—¶æ—¶é—´(ms)
      retryCount: 3,         // é‡è¯•æ¬¡æ•°
      dataFields: [          // é‡‡é›†å­—æ®µ
        'price', 'volume', 'bid', 'ask', 'timestamp'
      ]
    }
  },
  { 
    id: 'collector_002', 
    name: 'OKXæ•°æ®æ”¶é›†å™¨', 
    status: 'stopped',
    config: {
      exchange: 'okx',
      symbols: ['BTC-USDT', 'ETH-USDT'],
      interval: 1000,
      batchSize: 100,
      timeout: 5000,
      retryCount: 3,
      dataFields: ['price', 'volume', 'bid', 'ask', 'timestamp']
    }
  },
  { 
    id: 'collector_003', 
    name: 'Huobiæ•°æ®æ”¶é›†å™¨', 
    status: 'stopped',
    config: {
      exchange: 'huobi',
      symbols: ['btcusdt', 'ethusdt'],
      interval: 1000,
      batchSize: 100,
      timeout: 5000,
      retryCount: 3,
      dataFields: ['price', 'volume', 'bid', 'ask', 'timestamp']
    }
  }
];

// æ•°æ®æ”¶é›†å™¨API
app.get('/api/qingxi/collectors/list', (req, res) => {
  console.log('ğŸ“¡ æ•°æ®æ”¶é›†å™¨åˆ—è¡¨æŸ¥è¯¢');
  res.json(dataCollectors);
});
```

### 3. ç­–ç•¥æ¨¡å— (CeLue - Strategy Module)

#### æ¨¡å—èŒè´£
- å¥—åˆ©ç­–ç•¥ç®¡ç†
- ç­–ç•¥æ‰§è¡Œç›‘æ§
- æ”¶ç›Šè®¡ç®—ä¸åˆ†æ
- é£é™©è¯„ä¼°

#### ç­–ç•¥é…ç½®ç»“æ„
```javascript
// ç­–ç•¥é…ç½®æ¨¡æ¿
const strategyConfig = {
  triangular_arbitrage: {
    enabled: true,
    name: 'ä¸‰è§’å¥—åˆ©ç­–ç•¥',
    parameters: {
      min_profit_threshold: 0.002,    // æœ€å°åˆ©æ¶¦é˜ˆå€¼ 0.2%
      max_position_size: 10000,       // æœ€å¤§æŒä»“(USDT)
      execution_timeout: 500,         // æ‰§è¡Œè¶…æ—¶(ms)
      slippage_tolerance: 0.001,      // æ»‘ç‚¹å®¹å¿åº¦ 0.1%
      fee_rate: 0.001,                // æ‰‹ç»­è´¹ç‡ 0.1%
      paths: [                         // å¥—åˆ©è·¯å¾„
        ['BTC/USDT', 'ETH/BTC', 'ETH/USDT'],
        ['BTC/USDT', 'BNB/BTC', 'BNB/USDT']
      ]
    }
  },
  cross_exchange_arbitrage: {
    enabled: true,
    name: 'è·¨äº¤æ˜“æ‰€å¥—åˆ©ç­–ç•¥',
    parameters: {
      min_spread: 0.003,               // æœ€å°ä»·å·® 0.3%
      max_exposure: 50000,             // æœ€å¤§æ•å£(USDT)
      hedge_ratio: 1.0,                // å¯¹å†²æ¯”ä¾‹
      rebalance_threshold: 0.1,        // å†å¹³è¡¡é˜ˆå€¼ 10%
      exchanges: ['binance', 'okx'],  // å‚ä¸äº¤æ˜“æ‰€
      symbols: ['BTC/USDT', 'ETH/USDT']
    }
  },
  market_making: {
    enabled: false,
    name: 'åšå¸‚ç­–ç•¥',
    parameters: {
      spread: 0.002,                   // ä»·å·® 0.2%
      order_amount: 1000,              // å•ç¬”è®¢å•é‡‘é¢
      order_refresh_time: 10000,       // è®¢å•åˆ·æ–°æ—¶é—´(ms)
      inventory_target: 0.5,           // åº“å­˜ç›®æ ‡æ¯”ä¾‹
      max_orders_per_side: 5           // æ¯è¾¹æœ€å¤§è®¢å•æ•°
    }
  }
};
```

### 4. é£é™©ç®¡ç†æ¨¡å— (Risk Management Module)

#### æ¨¡å—èŒè´£
- å®æ—¶é£é™©ç›‘æ§
- é£é™©æŒ‡æ ‡è®¡ç®—
- é¢„è­¦æœºåˆ¶è§¦å‘
- ç´§æ€¥æ­¢æŸæ‰§è¡Œ

#### é£é™©ç®¡ç†é€»è¾‘
```javascript
// é£é™©çŠ¶æ€ç®¡ç†
let riskStatus = {
  level: 'low',                    // é£é™©ç­‰çº§: low/medium/high/critical
  fund_safety: true,               // èµ„é‡‘å®‰å…¨çŠ¶æ€
  max_drawdown: 0.05,             // æœ€å¤§å›æ’¤
  current_exposure: 0.02,          // å½“å‰æ•å£
  risk_metrics: {
    var_95: 0.03,                 // 95% VaR
    var_99: 0.05,                 // 99% VaR
    sharpe_ratio: 2.5,            // å¤æ™®æ¯”ç‡
    sortino_ratio: 3.2,           // ç´¢æè¯ºæ¯”ç‡
    max_leverage: 3,              // æœ€å¤§æ æ†
    current_leverage: 1.5         // å½“å‰æ æ†
  },
  limits: {
    max_daily_loss: 0.05,         // æ—¥æœ€å¤§äºæŸ 5%
    max_position_size: 100000,    // æœ€å¤§æŒä»“
    max_open_orders: 50,          // æœ€å¤§å¼€æ”¾è®¢å•æ•°
    min_liquidity: 10000          // æœ€å°æµåŠ¨æ€§è¦æ±‚
  },
  alerts: []                      // é£é™©è­¦æŠ¥åˆ—è¡¨
};

// é£é™©æ£€æŸ¥å‡½æ•°
function checkRiskLimits() {
  const alerts = [];
  
  // æ£€æŸ¥å›æ’¤
  if (riskStatus.current_exposure > riskStatus.max_drawdown * 0.8) {
    alerts.push({
      level: 'warning',
      message: 'æ¥è¿‘æœ€å¤§å›æ’¤é™åˆ¶',
      value: riskStatus.current_exposure
    });
  }
  
  // æ£€æŸ¥æ æ†
  if (riskStatus.risk_metrics.current_leverage > riskStatus.risk_metrics.max_leverage * 0.9) {
    alerts.push({
      level: 'warning', 
      message: 'æ æ†æ¥è¿‘ä¸Šé™',
      value: riskStatus.risk_metrics.current_leverage
    });
  }
  
  // æ›´æ–°é£é™©ç­‰çº§
  if (alerts.length > 3) {
    riskStatus.level = 'high';
  } else if (alerts.length > 1) {
    riskStatus.level = 'medium';
  } else {
    riskStatus.level = 'low';
  }
  
  riskStatus.alerts = alerts;
  return alerts;
}
```

### 5. æ¶æ„ç›‘æ§æ¨¡å— (Architecture Monitor Module)

#### æ¨¡å—èŒè´£
- ç³»ç»Ÿæ¶æ„å¥åº·æ£€æŸ¥
- æœåŠ¡ä¾èµ–ç›‘æ§
- æ€§èƒ½ç“¶é¢ˆåˆ†æ
- å®¹é‡è§„åˆ’å»ºè®®

#### ç›‘æ§é…ç½®
```javascript
// æ¶æ„ç›‘æ§é…ç½®
const architectureConfig = {
  services: {
    api_gateway: {
      name: 'APIç½‘å…³',
      endpoint: 'http://localhost:8080/health',
      check_interval: 5000,
      timeout: 3000,
      metrics: ['response_time', 'error_rate', 'throughput']
    },
    data_processor: {
      name: 'æ•°æ®å¤„ç†å™¨',
      endpoint: 'internal://qingxi',
      check_interval: 10000,
      timeout: 5000,
      metrics: ['processing_rate', 'queue_size', 'error_count']
    },
    strategy_engine: {
      name: 'ç­–ç•¥å¼•æ“',
      endpoint: 'internal://celue',
      check_interval: 5000,
      timeout: 3000,
      metrics: ['execution_count', 'success_rate', 'avg_latency']
    }
  },
  thresholds: {
    response_time: 1000,          // å“åº”æ—¶é—´é˜ˆå€¼(ms)
    error_rate: 0.01,            // é”™è¯¯ç‡é˜ˆå€¼ 1%
    cpu_usage: 80,               // CPUä½¿ç”¨ç‡é˜ˆå€¼
    memory_usage: 85,            // å†…å­˜ä½¿ç”¨ç‡é˜ˆå€¼
    disk_usage: 90               // ç£ç›˜ä½¿ç”¨ç‡é˜ˆå€¼
  }
};
```

### 6. å¯è§‚æµ‹æ€§æ¨¡å— (Observability Module)

#### æ¨¡å—èŒè´£
- æ—¥å¿—èšåˆä¸åˆ†æ
- æŒ‡æ ‡æ”¶é›†ä¸å±•ç¤º
- é“¾è·¯è¿½è¸ª
- å‘Šè­¦ç®¡ç†

#### æ—¥å¿—ç®¡ç†ç³»ç»Ÿ
```javascript
// æ—¥å¿—ç®¡ç†é…ç½®
const loggingConfig = {
  levels: {
    DEBUG: 0,
    INFO: 1,
    WARN: 2,
    ERROR: 3,
    FATAL: 4
  },
  retention: {
    DEBUG: 1,      // å¤©
    INFO: 7,       // å¤©
    WARN: 30,      // å¤©
    ERROR: 90,     // å¤©
    FATAL: 365     // å¤©
  },
  rotation: {
    size: '100MB',
    interval: 'daily',
    compress: true,
    max_files: 10
  }
};

// ç³»ç»Ÿæ—¥å¿—è®°å½•
let systemLogs = [];

// æ—¥å¿—è®°å½•å‡½æ•°
function logMessage(level, message, metadata = {}) {
  const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
  const logEntry = {
    timestamp,
    level,
    message,
    metadata,
    source: 'system'
  };
  
  systemLogs.push(`${timestamp} [${level}] ${message}`);
  
  // ä¿ç•™æœ€è¿‘1000æ¡æ—¥å¿—
  if (systemLogs.length > 1000) {
    systemLogs = systemLogs.slice(-1000);
  }
  
  // è§¦å‘å‘Šè­¦
  if (level === 'ERROR' || level === 'FATAL') {
    triggerAlert(logEntry);
  }
  
  return logEntry;
}
```

---

## ğŸ’» ä»£ç å®ç°ä¸è¿è¡Œé€»è¾‘

### 1. æœåŠ¡å™¨åˆå§‹åŒ–æµç¨‹

```javascript
#!/usr/bin/env node

const express = require('express');
const cors = require('cors');
const app = express();
const port = 8080;

// 1. CORSé…ç½® - è§£å†³è·¨åŸŸé—®é¢˜
app.use(cors({
  origin: '*',                    // å…è®¸æ‰€æœ‰åŸŸå
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'Access-Control-Allow-Origin'],
  credentials: false
}));

// 2. é¢å¤–çš„CORSå¤´éƒ¨å¤„ç†
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  
  // é¢„æ£€è¯·æ±‚å¤„ç†
  if (req.method === 'OPTIONS') {
    console.log('ğŸ“‹ é¢„æ£€è¯·æ±‚ (OPTIONS):', req.url);
    res.status(200).send();
    return;
  }
  next();
});

// 3. JSONè§£æä¸­é—´ä»¶
app.use(express.json());

// 4. å¯åŠ¨æœåŠ¡å™¨
app.listen(port, '0.0.0.0', () => {
  console.log(`
ğŸ¯ çœŸå®APIæœåŠ¡å™¨å·²å¯åŠ¨ (v5.1.0)
ğŸ“¡ åœ°å€: http://localhost:${port}
ğŸ”— å¥åº·æ£€æŸ¥: http://localhost:${port}/health
`);
});
```

### 2. ç³»ç»ŸçŠ¶æ€æ›´æ–°æœºåˆ¶

```javascript
// ç³»ç»ŸæŒ‡æ ‡æ›´æ–°å‡½æ•°
function updateSystemMetrics() {
  if (systemStatus.isRunning) {
    // æ¨¡æ‹ŸçœŸå®çš„æ€§èƒ½æ•°æ®
    systemStatus.cpu_usage = 20 + Math.random() * 60;        // 20-80%
    systemStatus.memory_usage = 30 + Math.random() * 50;     // 30-80%
    systemStatus.network_latency = 10 + Math.random() * 40;  // 10-50ms
    
    // è®¡ç®—è¿è¡Œæ—¶é•¿
    systemStatus.uptime = systemStatus.lastStarted ? 
      (Date.now() - new Date(systemStatus.lastStarted).getTime()) / (1000 * 60 * 60) : 0;
    
    // éšæœºæ·»åŠ æ—¥å¿—
    if (Math.random() > 0.8) {
      const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
      const logTypes = ['INFO', 'WARN', 'DEBUG'];
      const logType = logTypes[Math.floor(Math.random() * logTypes.length)];
      const messages = [
        'å¥—åˆ©æœºä¼šæ£€æµ‹ä¸­...',
        'ä»·å·®åˆ†æå®Œæˆ',
        'è®¢å•æ‰§è¡ŒæˆåŠŸ',
        'é£é™©æ£€æŸ¥é€šè¿‡',
        'æ•°æ®åŒæ­¥å®Œæˆ'
      ];
      const message = messages[Math.floor(Math.random() * messages.length)];
      systemLogs.push(`${timestamp} [${logType}] ${message}`);
      
      // ä¿ç•™æœ€è¿‘100æ¡æ—¥å¿—
      if (systemLogs.length > 100) {
        systemLogs = systemLogs.slice(-100);
      }
    }
  }
}

// æ¯3ç§’æ›´æ–°ä¸€æ¬¡ç³»ç»ŸæŒ‡æ ‡
setInterval(updateSystemMetrics, 3000);
```

### 3. APIè·¯ç”±å¤„ç†é€»è¾‘

```javascript
// è·¯ç”±å¤„ç†ä¸­é—´ä»¶é“¾
const routeHandlers = {
  // ç³»ç»Ÿæ§åˆ¶è·¯ç”±
  systemRoutes: [
    { path: '/api/system/start', method: 'POST', handler: startSystem },
    { path: '/api/system/stop', method: 'POST', handler: stopSystem },
    { path: '/api/system/status', method: 'GET', handler: getSystemStatus },
    { path: '/api/system/logs', method: 'GET', handler: getSystemLogs }
  ],
  
  // é£é™©ç®¡ç†è·¯ç”±
  riskRoutes: [
    { path: '/api/risk/status', method: 'GET', handler: getRiskStatus },
    { path: '/api/risk/limits', method: 'GET', handler: getRiskLimits },
    { path: '/api/risk/alerts', method: 'GET', handler: getRiskAlerts }
  ],
  
  // æ•°æ®å¤„ç†è·¯ç”±
  dataRoutes: [
    { path: '/api/qingxi/collectors/list', method: 'GET', handler: getCollectorsList },
    { path: '/api/qingxi/collectors/start', method: 'POST', handler: startCollector },
    { path: '/api/qingxi/collectors/stop', method: 'POST', handler: stopCollector }
  ]
};

// æ³¨å†Œæ‰€æœ‰è·¯ç”±
Object.values(routeHandlers).flat().forEach(route => {
  app[route.method.toLowerCase()](route.path, route.handler);
});
```

---

## âš™ï¸ åŠŸèƒ½é…ç½®è¯¦è§£

### 1. ç³»ç»Ÿé…ç½®å‚æ•°

```javascript
// å…¨å±€ç³»ç»Ÿé…ç½®
const systemConfig = {
  // åŸºç¡€é…ç½®
  base: {
    version: '5.1.0',
    environment: process.env.NODE_ENV || 'production',
    port: process.env.PORT || 8080,
    host: process.env.HOST || '0.0.0.0',
    timezone: 'Asia/Shanghai'
  },
  
  // æ€§èƒ½é…ç½®
  performance: {
    max_connections: 1000,         // æœ€å¤§è¿æ¥æ•°
    request_timeout: 30000,        // è¯·æ±‚è¶…æ—¶(ms)
    keep_alive_timeout: 65000,     // ä¿æŒè¿æ¥è¶…æ—¶(ms)
    max_request_size: '10MB',      // æœ€å¤§è¯·æ±‚å¤§å°
    compression: true,             // å¯ç”¨å‹ç¼©
    cache_ttl: 300                 // ç¼“å­˜æ—¶é—´(ç§’)
  },
  
  // å®‰å…¨é…ç½®
  security: {
    rate_limit: {
      window: 60000,               // æ—¶é—´çª—å£(ms)
      max_requests: 100            // æœ€å¤§è¯·æ±‚æ•°
    },
    cors: {
      enabled: true,
      origins: ['*'],              // å…è®¸çš„æº
      credentials: false
    },
    headers: {
      'X-Frame-Options': 'DENY',
      'X-Content-Type-Options': 'nosniff',
      'X-XSS-Protection': '1; mode=block'
    }
  },
  
  // ç›‘æ§é…ç½®
  monitoring: {
    metrics_interval: 5000,        // æŒ‡æ ‡æ”¶é›†é—´éš”(ms)
    log_level: 'INFO',            // æ—¥å¿—çº§åˆ«
    health_check_interval: 10000, // å¥åº·æ£€æŸ¥é—´éš”(ms)
    alert_threshold: {
      cpu: 80,                    // CPUå‘Šè­¦é˜ˆå€¼(%)
      memory: 85,                 // å†…å­˜å‘Šè­¦é˜ˆå€¼(%)
      error_rate: 1               // é”™è¯¯ç‡å‘Šè­¦é˜ˆå€¼(%)
    }
  }
};
```

### 2. æ¨¡å—é…ç½®å‚æ•°

```javascript
// æ¨¡å—åŒ–é…ç½®ç®¡ç†
const moduleConfigs = {
  // ç³»ç»Ÿæ§åˆ¶æ¨¡å—é…ç½®
  system: {
    auto_start: false,             // è‡ªåŠ¨å¯åŠ¨
    startup_delay: 5000,           // å¯åŠ¨å»¶è¿Ÿ(ms)
    shutdown_timeout: 30000,       // å…³é—­è¶…æ—¶(ms)
    health_check: {
      enabled: true,
      interval: 10000,             // æ£€æŸ¥é—´éš”(ms)
      timeout: 5000,               // è¶…æ—¶æ—¶é—´(ms)
      retries: 3                   // é‡è¯•æ¬¡æ•°
    }
  },
  
  // æ¸…æ´—æ¨¡å—é…ç½®
  qingxi: {
    collectors: {
      max_concurrent: 10,          // æœ€å¤§å¹¶å‘æ•°
      batch_size: 1000,           // æ‰¹å¤„ç†å¤§å°
      buffer_size: 10000,         // ç¼“å†²åŒºå¤§å°
      flush_interval: 5000        // åˆ·æ–°é—´éš”(ms)
    },
    processing: {
      threads: 4,                  // å¤„ç†çº¿ç¨‹æ•°
      queue_size: 50000,          // é˜Ÿåˆ—å¤§å°
      error_threshold: 0.05,      // é”™è¯¯é˜ˆå€¼ 5%
      retry_policy: {
        max_retries: 3,
        base_delay: 1000,         // åŸºç¡€å»¶è¿Ÿ(ms)
        max_delay: 30000          // æœ€å¤§å»¶è¿Ÿ(ms)
      }
    }
  },
  
  // ç­–ç•¥æ¨¡å—é…ç½®
  celue: {
    execution: {
      max_concurrent_strategies: 5, // æœ€å¤§å¹¶å‘ç­–ç•¥æ•°
      order_timeout: 5000,          // è®¢å•è¶…æ—¶(ms)
      slippage_protection: 0.005,   // æ»‘ç‚¹ä¿æŠ¤ 0.5%
      partial_fill_threshold: 0.8   // éƒ¨åˆ†æˆäº¤é˜ˆå€¼ 80%
    },
    optimization: {
      enabled: true,
      interval: 3600000,            // ä¼˜åŒ–é—´éš”(1å°æ—¶)
      lookback_period: 86400000,   // å›çœ‹å‘¨æœŸ(24å°æ—¶)
      min_sample_size: 1000         // æœ€å°æ ·æœ¬æ•°
    }
  },
  
  // é£é™©ç®¡ç†æ¨¡å—é…ç½®
  risk: {
    limits: {
      max_daily_loss: 0.05,        // æ—¥æœ€å¤§äºæŸ 5%
      max_position_size: 100000,   // æœ€å¤§æŒä»“(USDT)
      max_leverage: 3,             // æœ€å¤§æ æ†
      min_margin_ratio: 1.2        // æœ€å°ä¿è¯é‡‘ç‡
    },
    monitoring: {
      check_interval: 1000,        // æ£€æŸ¥é—´éš”(ms)
      alert_cooldown: 300000,      // å‘Šè­¦å†·å´(5åˆ†é’Ÿ)
      emergency_stop: true         // ç´§æ€¥åœæ­¢å¼€å…³
    }
  }
};
```

---

## ğŸ”„ æ•°æ®æµè½¬é€»è¾‘

### 1. æ•°æ®é‡‡é›†æµç¨‹

```mermaid
graph TD
    A[Exchange APIs] -->|Raw Data| B[Data Collectors]
    B -->|Normalized Data| C[Data Buffer]
    C -->|Batch Processing| D[QingXi Module]
    D -->|Clean Data| E[Data Store]
    E -->|Market Data| F[Strategy Engine]
    F -->|Trading Signals| G[Execution Module]
    G -->|Orders| H[Exchange APIs]
    
    D -->|Quality Metrics| I[Monitoring]
    F -->|Risk Metrics| J[Risk Manager]
    J -->|Controls| G
```

### 2. æ•°æ®å¤„ç†ç®¡é“

```javascript
// æ•°æ®å¤„ç†ç®¡é“å®ç°
class DataPipeline {
  constructor(config) {
    this.config = config;
    this.buffer = [];
    this.processors = [];
    this.output = null;
  }
  
  // æ·»åŠ å¤„ç†å™¨
  addProcessor(processor) {
    this.processors.push(processor);
    return this;
  }
  
  // å¤„ç†æ•°æ®
  async process(data) {
    let result = data;
    
    // ä¾æ¬¡é€šè¿‡æ‰€æœ‰å¤„ç†å™¨
    for (const processor of this.processors) {
      try {
        result = await processor.process(result);
      } catch (error) {
        console.error(`å¤„ç†å™¨é”™è¯¯: ${processor.name}`, error);
        // é”™è¯¯å¤„ç†ç­–ç•¥
        if (processor.critical) {
          throw error;
        }
      }
    }
    
    return result;
  }
  
  // æ‰¹é‡å¤„ç†
  async processBatch() {
    if (this.buffer.length === 0) return;
    
    const batch = this.buffer.splice(0, this.config.batch_size);
    const results = await Promise.all(
      batch.map(item => this.process(item))
    );
    
    // è¾“å‡ºç»“æœ
    if (this.output) {
      await this.output.write(results);
    }
    
    return results;
  }
}

// æ•°æ®å¤„ç†å™¨ç¤ºä¾‹
const processors = {
  // æ•°æ®éªŒè¯å™¨
  validator: {
    name: 'validator',
    critical: true,
    process: async (data) => {
      if (!data.price || !data.volume || !data.timestamp) {
        throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
      }
      return data;
    }
  },
  
  // æ•°æ®æ ‡å‡†åŒ–å™¨
  normalizer: {
    name: 'normalizer',
    critical: false,
    process: async (data) => {
      return {
        ...data,
        price: parseFloat(data.price),
        volume: parseFloat(data.volume),
        timestamp: new Date(data.timestamp).getTime()
      };
    }
  },
  
  // å¼‚å¸¸æ£€æµ‹å™¨
  anomalyDetector: {
    name: 'anomaly_detector',
    critical: false,
    process: async (data) => {
      // ç®€å•çš„å¼‚å¸¸æ£€æµ‹é€»è¾‘
      if (data.price <= 0 || data.price > 1000000) {
        data.anomaly = true;
        data.anomaly_reason = 'price_out_of_range';
      }
      return data;
    }
  }
};
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å†…å­˜ä¼˜åŒ–

```javascript
// å†…å­˜ç®¡ç†ç­–ç•¥
const memoryManagement = {
  // ç¼“å­˜ç®¡ç†
  cache: {
    max_size: 100 * 1024 * 1024,  // 100MB
    ttl: 300000,                  // 5åˆ†é’Ÿ
    eviction_policy: 'LRU',       // æœ€è¿‘æœ€å°‘ä½¿ç”¨
    
    // ç¼“å­˜æ¸…ç†
    cleanup: function() {
      const now = Date.now();
      for (const key in this.store) {
        if (now - this.store[key].timestamp > this.ttl) {
          delete this.store[key];
        }
      }
    }
  },
  
  // å†…å­˜ç›‘æ§
  monitor: {
    check_interval: 60000,         // 1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    threshold: 0.85,               // 85%å‘Šè­¦é˜ˆå€¼
    
    check: function() {
      const used = process.memoryUsage();
      const heapUsedPercent = used.heapUsed / used.heapTotal;
      
      if (heapUsedPercent > this.threshold) {
        console.warn(`âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${(heapUsedPercent * 100).toFixed(2)}%`);
        // è§¦å‘åƒåœ¾å›æ”¶
        if (global.gc) {
          global.gc();
        }
      }
      
      return {
        rss: used.rss / 1024 / 1024,           // MB
        heapTotal: used.heapTotal / 1024 / 1024,
        heapUsed: used.heapUsed / 1024 / 1024,
        external: used.external / 1024 / 1024
      };
    }
  }
};

// å®šæœŸæ¸…ç†
setInterval(() => {
  memoryManagement.cache.cleanup();
  memoryManagement.monitor.check();
}, 60000);
```

### 2. å¹¶å‘æ§åˆ¶

```javascript
// å¹¶å‘æ§åˆ¶å™¨
class ConcurrencyController {
  constructor(maxConcurrent = 10) {
    this.maxConcurrent = maxConcurrent;
    this.running = 0;
    this.queue = [];
  }
  
  async execute(fn) {
    // ç­‰å¾…ç©ºé—²æ§½ä½
    while (this.running >= this.maxConcurrent) {
      await new Promise(resolve => {
        this.queue.push(resolve);
      });
    }
    
    this.running++;
    
    try {
      return await fn();
    } finally {
      this.running--;
      
      // é‡Šæ”¾ç­‰å¾…çš„ä»»åŠ¡
      if (this.queue.length > 0) {
        const resolve = this.queue.shift();
        resolve();
      }
    }
  }
  
  // æ‰¹é‡æ‰§è¡Œ
  async executeAll(tasks) {
    return Promise.all(
      tasks.map(task => this.execute(task))
    );
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const concurrency = new ConcurrencyController(5);

// é™åˆ¶å¹¶å‘APIè¯·æ±‚
async function fetchMarketData(symbols) {
  return concurrency.executeAll(
    symbols.map(symbol => async () => {
      const response = await fetch(`/api/market/${symbol}`);
      return response.json();
    })
  );
}
```

### 3. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

```javascript
// æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
const queryOptimization = {
  // æ‰¹é‡æŸ¥è¯¢
  batchQuery: async function(ids, batchSize = 100) {
    const results = [];
    
    for (let i = 0; i < ids.length; i += batchSize) {
      const batch = ids.slice(i, i + batchSize);
      const batchResult = await this.executeBatch(batch);
      results.push(...batchResult);
    }
    
    return results;
  },
  
  // æŸ¥è¯¢ç¼“å­˜
  cachedQuery: function() {
    const cache = new Map();
    const ttl = 60000; // 1åˆ†é’Ÿ
    
    return async function(query) {
      const key = JSON.stringify(query);
      const cached = cache.get(key);
      
      if (cached && Date.now() - cached.timestamp < ttl) {
        return cached.data;
      }
      
      const result = await executeQuery(query);
      cache.set(key, {
        data: result,
        timestamp: Date.now()
      });
      
      return result;
    };
  },
  
  // ç´¢å¼•ä¼˜åŒ–å»ºè®®
  indexSuggestions: {
    frequently_queried_fields: ['timestamp', 'symbol', 'exchange'],
    composite_indexes: [
      ['symbol', 'timestamp'],
      ['exchange', 'symbol', 'timestamp']
    ],
    covering_indexes: [
      { fields: ['symbol', 'price', 'volume'], include: ['timestamp'] }
    ]
  }
};
```

---

## ğŸ”§ éƒ¨ç½²ä¸è¿ç»´

### 1. ç³»ç»Ÿéƒ¨ç½²æµç¨‹

```bash
#!/bin/bash
# 5.1ç³»ç»Ÿéƒ¨ç½²è„šæœ¬

# 1. ç¯å¢ƒæ£€æŸ¥
check_environment() {
    echo "ğŸ” æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ..."
    
    # æ£€æŸ¥Node.js
    if ! command -v node &> /dev/null; then
        echo "âŒ Node.jsæœªå®‰è£…"
        exit 1
    fi
    
    # æ£€æŸ¥npm
    if ! command -v npm &> /dev/null; then
        echo "âŒ npmæœªå®‰è£…"
        exit 1
    fi
    
    echo "âœ… ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
}

# 2. å®‰è£…ä¾èµ–
install_dependencies() {
    echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
    npm install express cors
    echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
}

# 3. é…ç½®ç³»ç»ŸæœåŠ¡
setup_systemd() {
    echo "âš™ï¸ é…ç½®ç³»ç»ŸæœåŠ¡..."
    
    cat > /etc/systemd/system/arbitrage-system.service << EOF
[Unit]
Description=5.1 Arbitrage System
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu
ExecStart=/usr/bin/node /home/ubuntu/real-api-server.js
Restart=always
RestartSec=10
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=arbitrage-system
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    systemctl enable arbitrage-system
    echo "âœ… ç³»ç»ŸæœåŠ¡é…ç½®å®Œæˆ"
}

# 4. å¯åŠ¨æœåŠ¡
start_service() {
    echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
    systemctl start arbitrage-system
    systemctl status arbitrage-system
}

# æ‰§è¡Œéƒ¨ç½²
main() {
    check_environment
    install_dependencies
    setup_systemd
    start_service
    echo "âœ… 5.1ç³»ç»Ÿéƒ¨ç½²å®Œæˆï¼"
}

main
```

### 2. ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# system-monitor.sh - ç³»ç»Ÿç›‘æ§è„šæœ¬

echo "=== 5.1å¥—åˆ©ç³»ç»Ÿå¯åŠ¨ç›‘æ§ç»ˆç«¯ ==="
echo "æ—¶é—´: $(date)"
echo "ç­‰å¾…ç³»ç»Ÿå¯åŠ¨è¯·æ±‚..."
echo "----------------------------------------"

while true; do
  # è·å–ç³»ç»ŸçŠ¶æ€
  status=$(curl -s http://localhost:8080/api/system/status | jq -r '.data.isRunning // "unknown"')
  timestamp=$(date '+%Y-%m-%d %H:%M:%S')
  
  if [ "$status" = "true" ]; then
    echo "[$timestamp] âœ… ç³»ç»Ÿæ­£åœ¨è¿è¡Œä¸­"
    
    # è·å–æ€§èƒ½æŒ‡æ ‡
    uptime=$(curl -s http://localhost:8080/api/system/status | jq -r '.data.uptime // "N/A"' | xargs printf "%.2f")
    cpu=$(curl -s http://localhost:8080/api/system/status | jq -r '.data.cpu_usage // "N/A"' | xargs printf "%.1f")
    memory=$(curl -s http://localhost:8080/api/system/status | jq -r '.data.memory_usage // "N/A"' | xargs printf "%.1f")
    
    echo "[$timestamp] ğŸ“Š è¿è¡Œæ—¶é•¿: ${uptime}å°æ—¶, CPU: ${cpu}%, å†…å­˜: ${memory}%"
  elif [ "$status" = "false" ]; then
    echo "[$timestamp] â¹ï¸  ç³»ç»Ÿå·²åœæ­¢"
  else
    echo "[$timestamp] â“ ç³»ç»ŸçŠ¶æ€æœªçŸ¥"
  fi
  
  echo "----------------------------------------"
  sleep 5
done
```

### 3. æ—¥å¿—ç®¡ç†

```javascript
// æ—¥å¿—è½®è½¬é…ç½®
const logRotation = {
  // æ—¥å¿—æ–‡ä»¶é…ç½®
  files: {
    access: '/var/log/arbitrage/access.log',
    error: '/var/log/arbitrage/error.log',
    system: '/var/log/arbitrage/system.log',
    trade: '/var/log/arbitrage/trade.log'
  },
  
  // è½®è½¬ç­–ç•¥
  rotation: {
    size: '100M',          // æ–‡ä»¶å¤§å°é™åˆ¶
    interval: 'daily',     // è½®è½¬é—´éš”
    compress: true,        // å‹ç¼©æ—§æ–‡ä»¶
    max_files: 30,        // æœ€å¤§ä¿ç•™æ–‡ä»¶æ•°
    date_format: 'YYYY-MM-DD'
  },
  
  // æ—¥å¿—æ ¼å¼
  format: {
    timestamp: 'YYYY-MM-DD HH:mm:ss.SSS',
    level: true,
    pid: true,
    hostname: true,
    message: true,
    metadata: true
  }
};
```

---

## ğŸš¨ æ•…éšœå¤„ç†æ–¹æ¡ˆ

### 1. æ•…éšœæ£€æµ‹æœºåˆ¶

```javascript
// æ•…éšœæ£€æµ‹å™¨
class FaultDetector {
  constructor() {
    this.healthChecks = new Map();
    this.failures = new Map();
    this.config = {
      check_interval: 5000,      // æ£€æŸ¥é—´éš”
      failure_threshold: 3,      // å¤±è´¥é˜ˆå€¼
      recovery_threshold: 2,     // æ¢å¤é˜ˆå€¼
      timeout: 3000             // è¶…æ—¶æ—¶é—´
    };
  }
  
  // æ³¨å†Œå¥åº·æ£€æŸ¥
  register(name, checkFn) {
    this.healthChecks.set(name, {
      check: checkFn,
      status: 'unknown',
      lastCheck: null,
      failures: 0
    });
  }
  
  // æ‰§è¡Œå¥åº·æ£€æŸ¥
  async performCheck(name) {
    const health = this.healthChecks.get(name);
    if (!health) return;
    
    try {
      const result = await Promise.race([
        health.check(),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout')), this.config.timeout)
        )
      ]);
      
      // æ£€æŸ¥æˆåŠŸ
      health.status = 'healthy';
      health.failures = 0;
      health.lastCheck = Date.now();
      
      return { name, status: 'healthy', result };
      
    } catch (error) {
      // æ£€æŸ¥å¤±è´¥
      health.failures++;
      health.lastCheck = Date.now();
      
      if (health.failures >= this.config.failure_threshold) {
        health.status = 'unhealthy';
        this.handleFailure(name, error);
      } else {
        health.status = 'degraded';
      }
      
      return { name, status: health.status, error: error.message };
    }
  }
  
  // å¤„ç†æ•…éšœ
  handleFailure(name, error) {
    console.error(`ğŸš¨ æœåŠ¡æ•…éšœ: ${name}`, error);
    
    // æ•…éšœæ¢å¤ç­–ç•¥
    const strategies = {
      'api_gateway': this.restartApiGateway,
      'data_processor': this.restartDataProcessor,
      'strategy_engine': this.pauseStrategies,
      'risk_manager': this.emergencyStop
    };
    
    const strategy = strategies[name];
    if (strategy) {
      strategy.call(this);
    }
  }
  
  // ç´§æ€¥åœæ­¢
  emergencyStop() {
    console.error('ğŸ›‘ æ‰§è¡Œç´§æ€¥åœæ­¢ï¼');
    systemStatus.isRunning = false;
    
    // åœæ­¢æ‰€æœ‰æ¨¡å—
    Object.keys(systemStatus.modules).forEach(module => {
      systemStatus.modules[module].status = 'stopped';
    });
    
    // å‘é€å‘Šè­¦
    this.sendAlert({
      level: 'CRITICAL',
      message: 'ç³»ç»Ÿç´§æ€¥åœæ­¢',
      timestamp: new Date().toISOString()
    });
  }
}
```

### 2. æ•…éšœæ¢å¤ç­–ç•¥

```javascript
// æ•…éšœæ¢å¤ç®¡ç†å™¨
const recoveryManager = {
  // è‡ªåŠ¨æ¢å¤é…ç½®
  auto_recovery: {
    enabled: true,
    max_retries: 3,
    retry_delay: 5000,
    backoff_multiplier: 2
  },
  
  // æ¢å¤ç­–ç•¥
  strategies: {
    // æœåŠ¡é‡å¯
    restart: async function(service) {
      console.log(`ğŸ”„ é‡å¯æœåŠ¡: ${service}`);
      await this.stopService(service);
      await this.delay(1000);
      await this.startService(service);
    },
    
    // é™çº§è¿è¡Œ
    degrade: async function(service) {
      console.log(`âš ï¸ æœåŠ¡é™çº§: ${service}`);
      // å‡å°‘è´Ÿè½½
      moduleConfigs[service].max_concurrent = 
        Math.floor(moduleConfigs[service].max_concurrent / 2);
    },
    
    // æ•…éšœè½¬ç§»
    failover: async function(service) {
      console.log(`ğŸ”€ æ•…éšœè½¬ç§»: ${service}`);
      // åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡
      const backup = this.getBackupService(service);
      if (backup) {
        await this.activateBackup(backup);
      }
    },
    
    // æ•°æ®æ¢å¤
    recover_data: async function() {
      console.log(`ğŸ’¾ æ•°æ®æ¢å¤ä¸­...`);
      // ä»å¤‡ä»½æ¢å¤æ•°æ®
      await this.loadBackup();
      // é‡å»ºç´¢å¼•
      await this.rebuildIndexes();
      // éªŒè¯æ•°æ®å®Œæ•´æ€§
      await this.validateData();
    }
  },
  
  // æ‰§è¡Œæ¢å¤
  async execute(failure) {
    const strategy = this.selectStrategy(failure);
    let retries = 0;
    let delay = this.auto_recovery.retry_delay;
    
    while (retries < this.auto_recovery.max_retries) {
      try {
        await strategy(failure.service);
        console.log(`âœ… æ¢å¤æˆåŠŸ: ${failure.service}`);
        return true;
        
      } catch (error) {
        console.error(`âŒ æ¢å¤å¤±è´¥ (å°è¯• ${retries + 1}):`, error);
        retries++;
        await this.delay(delay);
        delay *= this.auto_recovery.backoff_multiplier;
      }
    }
    
    console.error(`ğŸš¨ æ¢å¤å¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥: ${failure.service}`);
    return false;
  }
};
```

---

## ğŸ“ å¼€å‘æœ€ä½³å®è·µ

### 1. ä»£ç è§„èŒƒ

```javascript
/**
 * 5.1ç³»ç»Ÿå¼€å‘è§„èŒƒ
 */

// 1. å‘½åè§„èŒƒ
const namingConventions = {
  // æ–‡ä»¶å‘½åï¼šå°å†™+è¿å­—ç¬¦
  files: 'module-name.js',
  
  // ç±»å‘½åï¼šå¸•æ–¯å¡å‘½åæ³•
  classes: 'DataProcessor',
  
  // å‡½æ•°å‘½åï¼šé©¼å³°å‘½åæ³•
  functions: 'processMarketData',
  
  // å¸¸é‡å‘½åï¼šå¤§å†™+ä¸‹åˆ’çº¿
  constants: 'MAX_RETRY_COUNT',
  
  // ç§æœ‰å±æ€§ï¼šä¸‹åˆ’çº¿å‰ç¼€
  private: '_internalState'
};

// 2. é”™è¯¯å¤„ç†è§„èŒƒ
class SystemError extends Error {
  constructor(code, message, details = {}) {
    super(message);
    this.name = 'SystemError';
    this.code = code;
    this.details = details;
    this.timestamp = new Date().toISOString();
  }
  
  toJSON() {
    return {
      name: this.name,
      code: this.code,
      message: this.message,
      details: this.details,
      timestamp: this.timestamp,
      stack: this.stack
    };
  }
}

// é”™è¯¯ç å®šä¹‰
const ErrorCodes = {
  // ç³»ç»Ÿé”™è¯¯ (1xxx)
  SYSTEM_ERROR: 1000,
  SYSTEM_NOT_INITIALIZED: 1001,
  SYSTEM_ALREADY_RUNNING: 1002,
  
  // æ•°æ®é”™è¯¯ (2xxx)
  DATA_INVALID: 2000,
  DATA_MISSING: 2001,
  DATA_CORRUPTED: 2002,
  
  // ç½‘ç»œé”™è¯¯ (3xxx)
  NETWORK_ERROR: 3000,
  NETWORK_TIMEOUT: 3001,
  NETWORK_DISCONNECTED: 3002,
  
  // ä¸šåŠ¡é”™è¯¯ (4xxx)
  STRATEGY_ERROR: 4000,
  RISK_LIMIT_EXCEEDED: 4001,
  INSUFFICIENT_BALANCE: 4002
};

// 3. å¼‚æ­¥å¤„ç†è§„èŒƒ
const asyncPatterns = {
  // Promiseé”™è¯¯å¤„ç†
  withErrorHandler: async function(fn) {
    try {
      return await fn();
    } catch (error) {
      console.error('å¼‚æ­¥é”™è¯¯:', error);
      throw new SystemError(
        ErrorCodes.SYSTEM_ERROR,
        error.message,
        { originalError: error }
      );
    }
  },
  
  // è¶…æ—¶æ§åˆ¶
  withTimeout: function(promise, timeout = 5000) {
    return Promise.race([
      promise,
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Timeout')), timeout)
      )
    ]);
  },
  
  // é‡è¯•æœºåˆ¶
  withRetry: async function(fn, retries = 3, delay = 1000) {
    for (let i = 0; i < retries; i++) {
      try {
        return await fn();
      } catch (error) {
        if (i === retries - 1) throw error;
        await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
      }
    }
  }
};
```

### 2. æµ‹è¯•ç­–ç•¥

```javascript
// æµ‹è¯•æ¡†æ¶é…ç½®
const testConfig = {
  // å•å…ƒæµ‹è¯•
  unit: {
    framework: 'jest',
    coverage: {
      threshold: 80,
      reporters: ['text', 'html', 'lcov']
    },
    patterns: ['**/*.test.js', '**/*.spec.js']
  },
  
  // é›†æˆæµ‹è¯•
  integration: {
    framework: 'supertest',
    timeout: 10000,
    database: 'test_db',
    fixtures: './test/fixtures'
  },
  
  // æ€§èƒ½æµ‹è¯•
  performance: {
    framework: 'artillery',
    scenarios: [
      {
        name: 'normal_load',
        duration: 300,
        rate: 10
      },
      {
        name: 'peak_load',
        duration: 60,
        rate: 100
      }
    ]
  }
};

// æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹
describe('System Control Module', () => {
  let server;
  
  beforeAll(() => {
    server = require('./real-api-server');
  });
  
  afterAll(() => {
    server.close();
  });
  
  test('ç³»ç»Ÿå¯åŠ¨æµ‹è¯•', async () => {
    const response = await request(server)
      .post('/api/system/start')
      .expect(200);
    
    expect(response.body.success).toBe(true);
    expect(response.body.data.status).toBe('started');
  });
  
  test('é‡å¤å¯åŠ¨æµ‹è¯•', async () => {
    // ç¬¬ä¸€æ¬¡å¯åŠ¨
    await request(server).post('/api/system/start');
    
    // é‡å¤å¯åŠ¨
    const response = await request(server)
      .post('/api/system/start')
      .expect(200);
    
    expect(response.body.data.status).toBe('already_running');
  });
});
```

### 3. æ€§èƒ½ç›‘æ§

```javascript
// æ€§èƒ½ç›‘æ§å™¨
class PerformanceMonitor {
  constructor() {
    this.metrics = {
      requests: new Map(),
      operations: new Map(),
      resources: {
        cpu: [],
        memory: [],
        network: []
      }
    };
  }
  
  // è¯·æ±‚è®¡æ—¶
  trackRequest(req, res, next) {
    const start = Date.now();
    const path = req.path;
    
    res.on('finish', () => {
      const duration = Date.now() - start;
      const status = res.statusCode;
      
      if (!this.metrics.requests.has(path)) {
        this.metrics.requests.set(path, {
          count: 0,
          total_time: 0,
          avg_time: 0,
          min_time: Infinity,
          max_time: 0,
          errors: 0
        });
      }
      
      const metric = this.metrics.requests.get(path);
      metric.count++;
      metric.total_time += duration;
      metric.avg_time = metric.total_time / metric.count;
      metric.min_time = Math.min(metric.min_time, duration);
      metric.max_time = Math.max(metric.max_time, duration);
      
      if (status >= 400) {
        metric.errors++;
      }
    });
    
    next();
  }
  
  // æ“ä½œè®¡æ—¶
  async trackOperation(name, operation) {
    const start = Date.now();
    
    try {
      const result = await operation();
      const duration = Date.now() - start;
      
      this.recordOperation(name, duration, true);
      return result;
      
    } catch (error) {
      const duration = Date.now() - start;
      this.recordOperation(name, duration, false);
      throw error;
    }
  }
  
  // è®°å½•æ“ä½œæŒ‡æ ‡
  recordOperation(name, duration, success) {
    if (!this.metrics.operations.has(name)) {
      this.metrics.operations.set(name, {
        count: 0,
        success: 0,
        failure: 0,
        total_time: 0,
        avg_time: 0
      });
    }
    
    const metric = this.metrics.operations.get(name);
    metric.count++;
    metric.total_time += duration;
    metric.avg_time = metric.total_time / metric.count;
    
    if (success) {
      metric.success++;
    } else {
      metric.failure++;
    }
  }
  
  // ç”ŸæˆæŠ¥å‘Š
  generateReport() {
    return {
      timestamp: new Date().toISOString(),
      requests: Object.fromEntries(this.metrics.requests),
      operations: Object.fromEntries(this.metrics.operations),
      resources: {
        cpu: this.calculateAverage(this.metrics.resources.cpu),
        memory: this.calculateAverage(this.metrics.resources.memory),
        network: this.calculateAverage(this.metrics.resources.network)
      }
    };
  }
}
```

---

## ğŸ“Š ç³»ç»ŸæŒ‡æ ‡ä¸ç›‘æ§

### å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPIs)

```javascript
// KPIå®šä¹‰
const kpis = {
  // ç³»ç»Ÿå¯ç”¨æ€§
  availability: {
    target: 99.9,                  // ç›®æ ‡å¯ç”¨æ€§ 99.9%
    measurement: 'uptime / total_time * 100',
    alert_threshold: 99.5
  },
  
  // å“åº”æ—¶é—´
  response_time: {
    p50: 100,                      // 50åˆ†ä½æ•° < 100ms
    p95: 500,                      // 95åˆ†ä½æ•° < 500ms
    p99: 1000,                     // 99åˆ†ä½æ•° < 1000ms
    alert_threshold: 2000
  },
  
  // ååé‡
  throughput: {
    target: 1000,                  // ç›®æ ‡QPS
    measurement: 'requests / second',
    alert_threshold: 100
  },
  
  // é”™è¯¯ç‡
  error_rate: {
    target: 0.1,                   // ç›®æ ‡é”™è¯¯ç‡ < 0.1%
    measurement: 'errors / total_requests * 100',
    alert_threshold: 1
  },
  
  // ä¸šåŠ¡æŒ‡æ ‡
  business: {
    daily_profit: {
      target: 1000,               // æ—¥ç›®æ ‡æ”¶ç›Š(USDT)
      measurement: 'sum(profits)',
      alert_threshold: -500
    },
    success_rate: {
      target: 95,                 // ç­–ç•¥æˆåŠŸç‡ > 95%
      measurement: 'successful_trades / total_trades * 100',
      alert_threshold: 90
    },
    risk_score: {
      target: 30,                 // é£é™©åˆ†æ•° < 30
      measurement: 'calculated_risk_score',
      alert_threshold: 50
    }
  }
};
```

---

## ğŸ” å®‰å…¨æªæ–½

### 1. APIå®‰å…¨

```javascript
// APIå®‰å…¨ä¸­é—´ä»¶
const securityMiddleware = {
  // é€Ÿç‡é™åˆ¶
  rateLimit: {
    windowMs: 60 * 1000,          // 1åˆ†é’Ÿçª—å£
    max: 100,                      // æœ€å¤§è¯·æ±‚æ•°
    message: 'Too many requests',
    standardHeaders: true,
    legacyHeaders: false
  },
  
  // APIå¯†é’¥éªŒè¯
  apiKeyAuth: (req, res, next) => {
    const apiKey = req.headers['x-api-key'];
    
    if (!apiKey || !isValidApiKey(apiKey)) {
      return res.status(401).json({
        success: false,
        error: 'Invalid API key'
      });
    }
    
    next();
  },
  
  // è¾“å…¥éªŒè¯
  validateInput: (schema) => {
    return (req, res, next) => {
      const { error } = schema.validate(req.body);
      
      if (error) {
        return res.status(400).json({
          success: false,
          error: error.details[0].message
        });
      }
      
      next();
    };
  }
};
```

### 2. æ•°æ®åŠ å¯†

```javascript
// åŠ å¯†é…ç½®
const encryption = {
  algorithm: 'aes-256-gcm',
  keyDerivation: 'pbkdf2',
  iterations: 100000,
  saltLength: 32,
  
  // æ•æ„Ÿæ•°æ®åŠ å¯†
  encryptSensitiveData: function(data, key) {
    const iv = crypto.randomBytes(16);
    const salt = crypto.randomBytes(this.saltLength);
    const derivedKey = crypto.pbkdf2Sync(
      key, 
      salt, 
      this.iterations, 
      32, 
      'sha256'
    );
    
    const cipher = crypto.createCipheriv(this.algorithm, derivedKey, iv);
    const encrypted = Buffer.concat([
      cipher.update(JSON.stringify(data), 'utf8'),
      cipher.final()
    ]);
    
    const authTag = cipher.getAuthTag();
    
    return {
      encrypted: encrypted.toString('base64'),
      salt: salt.toString('base64'),
      iv: iv.toString('base64'),
      authTag: authTag.toString('base64')
    };
  }
};
```

---

## ğŸ“‹ æ€»ç»“

### å¼€å‘æˆæœ
1. âœ… å®Œæ•´çš„åç«¯APIæ¶æ„å®ç°
2. âœ… æ¨¡å—åŒ–çš„ç³»ç»Ÿè®¾è®¡
3. âœ… å®æ—¶æ€§èƒ½ç›‘æ§æœºåˆ¶
4. âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤ç­–ç•¥
5. âœ… å¯æ‰©å±•çš„é…ç½®ç®¡ç†ç³»ç»Ÿ
6. âœ… ç”Ÿäº§çº§çš„éƒ¨ç½²æ–¹æ¡ˆ

### æŠ€æœ¯ç‰¹ç‚¹
- **é«˜æ€§èƒ½**: å¼‚æ­¥I/Oã€å¹¶å‘æ§åˆ¶ã€ç¼“å­˜ä¼˜åŒ–
- **é«˜å¯ç”¨**: æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ¢å¤ã€é™çº§ç­–ç•¥
- **å¯æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ã€æ’ä»¶æœºåˆ¶ã€é…ç½®é©±åŠ¨
- **å¯ç»´æŠ¤**: ä»£ç è§„èŒƒã€æµ‹è¯•è¦†ç›–ã€æ–‡æ¡£å®Œå–„
- **å®‰å…¨æ€§**: APIè®¤è¯ã€æ•°æ®åŠ å¯†ã€è®¿é—®æ§åˆ¶

### æœªæ¥ä¼˜åŒ–æ–¹å‘
1. ğŸ”„ å¾®æœåŠ¡æ¶æ„æ”¹é€ 
2. ğŸ“Š å®æ—¶æ•°æ®æµå¤„ç†(Kafka/RabbitMQ)
3. ğŸ—„ï¸ åˆ†å¸ƒå¼å­˜å‚¨æ–¹æ¡ˆ
4. ğŸ¤– æœºå™¨å­¦ä¹ ç­–ç•¥ä¼˜åŒ–
5. ğŸŒ å¤šåŒºåŸŸéƒ¨ç½²æ”¯æŒ
6. ğŸ“± ç§»åŠ¨ç«¯APIé€‚é…

---

**æ–‡æ¡£ç»´æŠ¤è€…**: 5.1ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-09-06  
**è”ç³»æ–¹å¼**: ç³»ç»Ÿç®¡ç†ç•Œé¢å†…ç½®å¸®åŠ©ç³»ç»Ÿ