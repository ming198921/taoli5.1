# ğŸš€ QINGXIç”Ÿäº§ç¯å¢ƒDockeré…ç½®
# å¤šé˜¶æ®µæ„å»ºï¼Œä¼˜åŒ–é•œåƒå¤§å°ï¼Œç”Ÿäº§å°±ç»ª

# æ„å»ºé˜¶æ®µ
FROM rust:1.75 as builder

WORKDIR /usr/src/qingxi
COPY . .

# ä¼˜åŒ–ç¼–è¯‘é…ç½®
ENV CARGO_TARGET_DIR=/tmp/target
RUN cargo build --release --bin market_data_module

# ç”Ÿäº§è¿è¡Œé˜¶æ®µ
FROM debian:bookworm-slim

# å®‰è£…å¿…è¦çš„è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºç”¨æˆ·å’Œç›®å½•
RUN useradd -r -s /bin/false qingxi
RUN mkdir -p /app/configs /app/logs /app/data
RUN chown -R qingxi:qingxi /app

# å¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /tmp/target/release/market_data_module /app/
COPY --from=builder /usr/src/qingxi/configs/production.toml /app/configs/
COPY --from=builder /usr/src/qingxi/proto /app/proto

# è®¾ç½®å·¥ä½œç›®å½•å’Œç”¨æˆ·
WORKDIR /app
USER qingxi

# ç¯å¢ƒå˜é‡é…ç½®
ENV QINGXI_CONFIG_PATH="/app/configs/production.toml"
ENV QINGXI_LOG_DIR="/app/logs"
ENV RUST_LOG="info"
ENV RUST_BACKTRACE="1"

# ç”Ÿäº§ç¯å¢ƒç«¯å£
EXPOSE 50051 50052 50053 50061

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD pgrep market_data_module || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["./market_data_module"]

# æ ‡ç­¾ä¿¡æ¯
LABEL maintainer="QINGXI Team"
LABEL version="2.0"
LABEL description="QINGXI High-Performance Trading System - Production Ready"
